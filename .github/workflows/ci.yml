name: iOS CI

on:
  push:
    branches: [ main, 001-monica-ios-mvp, 'feature/**' ]
  pull_request:
    branches: [ main, 001-monica-ios-mvp ]

env:
  XCODE_VERSION: '15.2'
  IOS_SIMULATOR: 'iPhone 15'
  IOS_VERSION: '17.2'

jobs:
  build:
    name: Build and Validate
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available simulators
      run: xcrun simctl list devices available

    - name: Clean build artifacts
      run: |
        xcodebuild clean \
          -project K.xcodeproj \
          -scheme MonicaClient

    - name: Build for iOS Simulator
      run: |
        xcodebuild build \
          -project K.xcodeproj \
          -scheme MonicaClient \
          -sdk iphonesimulator \
          -destination "platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO \
          | xcpretty && exit ${PIPESTATUS[0]}

    - name: Archive build artifacts (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Logs/DiagnosticReports
          DerivedData/Logs
        retention-days: 7

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SwiftLint
      run: brew install swiftlint

    - name: Run SwiftLint
      run: |
        swiftlint lint --reporter github-actions-logging || true
        echo "::notice::SwiftLint check complete (non-blocking for MVP)"

  # Uncomment when tests are added
  # test:
  #   name: Run Tests
  #   runs-on: macos-14
  #   needs: build
  #
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Select Xcode version
  #     run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app/Contents/Developer
  #
  #   - name: Run unit tests
  #     run: |
  #       xcodebuild test \
  #         -project K.xcodeproj \
  #         -scheme MonicaClient \
  #         -sdk iphonesimulator \
  #         -destination "platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}" \
  #         -enableCodeCoverage YES \
  #         CODE_SIGN_IDENTITY="" \
  #         CODE_SIGNING_REQUIRED=NO \
  #         | xcpretty && exit ${PIPESTATUS[0]}
  #
  #   - name: Generate code coverage report
  #     run: |
  #       xcrun xccov view --report --json DerivedData/Logs/Test/*.xcresult > coverage.json
  #       cat coverage.json
  #
  #   - name: Upload coverage to Codecov
  #     uses: codecov/codecov-action@v4
  #     with:
  #       files: ./coverage.json
  #       fail_ci_if_error: false

  validate-spec:
    name: Validate SpecKit Documentation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate constitution
      run: |
        if [ ! -f ".specify/memory/constitution.md" ]; then
          echo "::error::Constitution file missing"
          exit 1
        fi
        echo "::notice::Constitution v$(grep 'Version:' .specify/memory/constitution.md | cut -d' ' -f2) validated"

    - name: Check for spec files
      run: |
        SPEC_COUNT=$(find specs -name "spec.md" 2>/dev/null | wc -l)
        echo "::notice::Found $SPEC_COUNT feature specifications"

    - name: Validate OpenAPI spec
      run: |
        if [ -f "docs/monica-api-openapi.yaml" ]; then
          echo "::notice::OpenAPI specification found"
          # Add openapi-validator here if needed
        fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Scan for secrets
      run: |
        # Check for common secret patterns
        if grep -r -E "(api[_-]?key|password|secret|token).*=.*['\"][A-Za-z0-9]{20,}" . \
          --exclude-dir=.git \
          --exclude-dir=DerivedData \
          --exclude-dir=docs \
          --exclude="*.md" \
          --exclude="*.yaml" \
          --exclude="*.html" \
          --exclude="ci.yml" 2>/dev/null; then
          echo "::error::Potential secrets found in code"
          exit 1
        fi
        echo "::notice::No hardcoded secrets detected"

    - name: Check for personal data in OpenAPI
      run: |
        if grep -i "synology\|noofincnet" docs/monica-api-openapi.yaml 2>/dev/null; then
          echo "::error::Personal URLs found in OpenAPI spec"
          exit 1
        fi
        echo "::notice::OpenAPI spec sanitized"

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, lint, validate-spec, security-scan]
    if: always()

    steps:
    - name: Check build results
      run: |
        if [ "${{ needs.build.result }}" == "success" ] && \
           [ "${{ needs.validate-spec.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "::notice::✅ All checks passed - ready to merge"
        else
          echo "::error::❌ Some checks failed - review required"
          exit 1
        fi
